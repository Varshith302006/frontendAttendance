<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance Dashboard</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
:root {
  /* Modern Color Palette */
  --primary: #6366f1;
  --primary-hover: #4f46e5;
  --primary-light: #eef2ff;
  --secondary: #8b5cf6;
  --success: #10b981;
  --success-light: #d1fae5;
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --info: #06b6d4;
  
  /* Neutrals - Light Mode */
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Gradient */
  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --gradient-danger: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
  
  /* Spacing */
  --radius: 12px;
  --radius-lg: 16px;
  --radius-full: 9999px;
}

/* Dark Mode */
body[data-theme="dark"] {
  /* Dark Mode Colors */
  --primary-light: #312e81;
  --success-light: #064e3b;
  --danger-light: #7f1d1d;
  --warning-light: #78350f;
  
  /* Neutrals - Dark Mode */
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --border: #334155;
  --border-light: #293548;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

/* Header */
header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 16px 0;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-sm);
}

.header-container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  width: 40px;
  height: 40px;
  background: var(--gradient-primary);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 18px;
}

header h2 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}
#themeToggle {
  width: 52px;
  height: 28px;
  border: none;
  background: #cbd5e1;
  border-radius: 14px;
  cursor: pointer;
  display: flex !important;
  align-items: center;
  padding: 2px;
  transition: background 0.3s ease;
  position: relative;
  flex-shrink: 0;
}
#themeToggle:hover {
  background: #94a3b8;
}

body[data-theme="dark"] #themeToggle {
  background: var(--primary);
}

body[data-theme="dark"] #themeToggle:hover {
  background: var(--primary-hover);
}
#themeIcon {
  width: 24px;
  height: 24px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  position: absolute;
  left: 2px;
}

body[data-theme="dark"] #themeIcon {
  transform: translateX(24px);
}

#visitsBadge {
  background: var(--primary-light);
  color: var(--primary);
  padding: 8px 16px;
  border-radius: var(--radius-full);
  font-weight: 600;
  font-size: 14px;
  display: none;
  align-items: center;
  gap: 8px;
}

#logoutBtn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius);
  background: var(--danger);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
  display: none;
}

#logoutBtn:hover {
  background: #dc2626;
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

/* Container */
.container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 32px 24px;
}

/* Login Card */
.login-card {
  background: var(--bg-secondary);
  padding: 48px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  max-width: 480px;
  margin: 80px auto;
  border: 1px solid var(--border);
}

.login-header {
  text-align: center;
  margin-bottom: 32px;
}

.login-icon {
  width: 64px;
  height: 64px;
  background: var(--gradient-primary);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  color: white;
  font-size: 32px;
}

.login-header h3 {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.login-header p {
  color: var(--text-secondary);
  font-size: 14px;
}

/* Form */
form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.field {
  position: relative;
}

.field label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.field input {
  width: 100%;
  height: 48px;
  padding: 0 16px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-size: 15px;
  transition: all 0.2s;
  background: var(--bg-primary);
  color: var(--text-primary);
}

.field input:focus {
  border-color: var(--primary);
  outline: none;
  background: var(--bg-secondary);
  box-shadow: 0 0 0 3px var(--primary-light);
  color: var(--text-primary);
}

.password-field input {
  padding-right: 48px;
}

.toggle-icon {
  position: absolute;
  right: 12px;
  top: 38px;
  cursor: pointer;
  color: var(--text-muted);
  transition: color 0.2s;
}

.toggle-icon:hover {
  color: var(--text-primary);
}

/* Button */
.btn {
  height: 48px;
  padding: 0 24px;
  background: var(--gradient-primary);
  border: none;
  color: white;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn:active {
  transform: translateY(0);
}

#formLoader {
  display: none;
  text-align: center;
  margin-top: 16px;
}

.loader {
  border: 3px solid var(--border);
  border-top: 3px solid var(--primary);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#formLoader p {
  color: var(--text-secondary);
  font-size: 14px;
}

/* Dashboard Grid */
.dashboard-grid {
  display: none;
  gap: 24px;
  margin-top: 32px;
  opacity: 0;
  transition: opacity 0.3s;
}

.dashboard-grid.show {
  opacity: 1;
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-secondary);
  padding: 24px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.stat-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.stat-card-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-card-icon {
  width: 48px;
  height: 48px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.stat-card-value {
  font-size: 36px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
  margin-bottom: 8px;
}

.stat-card-label {
  font-size: 13px;
  color: var(--text-muted);
}

/* Card */
.card {
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.card-header {
  padding: 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-body {
  padding: 24px;
}

/* Table */
.table-wrapper {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead {
  background: var(--bg-primary);
}

th {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
}

td {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
  color: var(--text-primary);
}

tr:last-child td {
  border-bottom: none;
}

tr:hover {
  background: var(--bg-primary);
}

/* Progress Bar */
.progress {
  background: var(--border-light);
  height: 24px;
  border-radius: var(--radius-full);
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
}

.progress-bar {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: 600;
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
}

.badge-success {
  background: var(--success-light);
  color: var(--success);
}

.badge-danger {
  background: var(--danger-light);
  color: var(--danger);
}

/* Simulation Card */
#todayClassesCard {
  display: none;
  margin-top: 24px;
}

.simulation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.simulation-controls {
  display: flex;
  gap: 12px;
}

#resetTodayBtn {
  width: 40px;
  height: 40px;
  border: 2px solid var(--border);
  background: var(--bg-secondary);
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 20px;
  color: var(--text-secondary);
  transition: all 0.2s;
  display: none;
}

#resetTodayBtn:hover {
  background: var(--bg-primary);
  color: var(--text-primary);
  border-color: var(--primary);
}

.today-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  margin-bottom: 16px;
  align-items: center;
}

.today-row select {
  height: 48px;
  padding: 0 16px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-size: 14px;
  background: var(--bg-primary);
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s;
}

.today-row select:hover {
  border-color: var(--primary);
}

.today-row select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-light);
  background: var(--bg-secondary);
}

.btn-container {
  display: flex;
  gap: 12px;
}

.today-row .btn {
  height: 48px;
  min-width: 120px;
}

.attend-btn {
  background: linear-gradient(135deg, #76d47b, #76ef7c);
}

.attend-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  background: #01ff5e;
}

.attend-btn.active {
  background: #45a049 !important;
}

.bunk-btn {
  background: linear-gradient(135deg, #f87f7d, #f67b7b);
}

.bunk-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(252, 2, 2, 0.15);
  background: #fc0101;
}

.bunk-btn.active {
  background: #e63a3a !important;
}

#newOverallAttendance {
  margin-top: 24px;
  padding: 20px;
  background: var(--primary-light);
  border-left: 4px solid var(--primary);
  border-radius: var(--radius);
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  color: var(--primary);
}

/* Grid Layout */
.grid-2 {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
}

/* Responsive */
@media (max-width: 768px) {
  .container {
    padding: 20px 16px;
  }

  .login-card {
    padding: 32px 24px;
    margin: 40px 16px;
  }

  .header-container {
    padding: 0 16px;
  }

  header h2 {
    font-size: 16px;
  }

  .grid-2 {
    grid-template-columns: 1fr;
  }

  .today-row {
    grid-template-columns: 1fr;
  }

  .btn-container {
    width: 100%;
  }

  .today-row .btn {
    flex: 1;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  table {
    font-size: 12px;
  }

  th, td {
    padding: 8px;
  }
}
@media (max-width: 768px) {
  .table-wrapper {
    position: relative;
  }
  .table-wrapper::after {
    content: '';
    pointer-events: none;
    display: block;
    position: absolute;
    right: 0; top: 0; bottom: 0;
    width: 32px;
    background: linear-gradient(to left, var(--bg-primary), transparent 75%);
    z-index: 2;
    opacity: 1;
    transition: opacity 0.4s;
  }
  .table-wrapper.scrolled-end::after {
    opacity: 0;
  }
  .table-scroll-hint {
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 4px;
    text-align: right;
    padding-right: 8px;
    display: block;
  }
}

@media (max-width: 480px) {
  .login-card {
    padding: 24px 20px;
  }

  .stat-card-value {
    font-size: 28px;
  }

  .card-header, .card-body {
    padding: 16px;
  }
  /* Academic Attendance Table - 3D Horizontal Scroll Effect */
.table-wrapper {
  box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1.5px 4px rgba(40,37,86,0.10);
  border-radius: 18px;
  background: var(--bg-secondary);
  padding: 8px 0;
  perspective: 800px;
}
.table-wrapper table {
  background: transparent;
  border-radius: 18px;
  overflow: hidden;
  transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
  box-shadow: 0 1px 10px rgba(25,40,60,0.06);
}
}

/* Loading State */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px;
  color: var(--text-secondary);
}

.loading-state .loader {
  margin-bottom: 16px;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.table-wrapper table {
  border-collapse: separate;
  border-spacing: 0;
}

.table-wrapper th, .table-wrapper td {
  border-bottom: 1px solid var(--border-light);
}
.table-wrapper tr:last-child td {
  border-bottom: none;
}

.table-wrapper th {
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  background: var(--bg-primary);
  text-align: center;
  font-size: 13px;
  letter-spacing: 0.04em;
}
.card-body .table-wrapper {
  margin: 0 4px 6px 4px;
  padding: 0 2px;
}
/* .card, .table-wrapper {
  background: #fff;
} */
body[data-theme="dark"] .table-wrapper {
  box-shadow: 0 4px 24px rgba(0,0,0,0.18), 0 1.5px 4px rgba(10,18,40,0.22);
  background: var(--bg-secondary);
}
body[data-theme="dark"] .table-wrapper table {
  background: var(--bg-primary);
}
body[data-theme="dark"] .table-wrapper::after {
  background: linear-gradient(to left, var(--bg-secondary), rgba(30,41,59,0) 75%);
  opacity: 0.7;
}
body[data-theme="dark"] .table-wrapper th {
  background: var(--bg-primary);
  color: var(--text-secondary);
}
</style>
</head>
<body>

<header>
  <div class="header-container">
    <div class="header-title">
      <div class="logo">üìä</div>
      <h2>My Attendance Dashboard</h2>
    </div>
    <div class="header-actions">
      <button id="themeToggle" title="Toggle dark mode" style="display: flex !important;">
        <span id="themeIcon">üåô</span>
      </button>
      <div id="visitsBadge">
        <span>üë•</span>
        <span id="visitsCount">0</span>
      </div>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Login Card -->
  <div class="login-card" id="loginCard">
    <div class="login-header">
      <div class="login-icon">üéì</div>
      <h3>Student Login</h3>
      <p>Enter your credentials to view your attendance</p>
    </div>
    <!-- <button id="fetchBtn" style="padding: 10px 20px; background: green; color: white; border: none; border-radius: 6px; cursor: pointer;">
      Fetch Attendance Now
    </button> -->
    
    <p id="statusMsg" style="margin-top: 10px; font-weight: bold;"></p>

    <form id="loginForm" autocomplete="on">
      <div class="field">
        <label for="username">Student ID</label>
        <input type="text" name="username" id="username" placeholder="Enter your student ID" required>
      </div>
      <div class="field password-field">
        <label for="passwordField">Password</label>
        <input type="password" name="password" id="passwordField" placeholder="Enter your password" required>
        <span id="togglePassword" class="toggle-icon">
          <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
          <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
            <path d="M3 3l18 18"/>
            <path d="M10.584 10.587a2 2 0 002.828 2.826"/>
            <path d="M9.363 5.365A9.466 9.466 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.963 9.963 0 01-1.363 2.419m-2.756 2.755A9.464 9.464 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.963 9.963 0 013.13-4.49"/>
          </svg>
        </span>
      </div>
      <button type="submit" class="btn" id="loginBtn">
        <span>Sign In</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
      <div id="formLoader">
        <div class="loader"></div>
        <p>Fetching your attendance data...<br>Please wait a moment</p>
      </div>
    </form>
  </div>
     
  <!-- Dashboard -->
  <div class="dashboard-grid" id="dashboardCards">
    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid"></div>
   <!-- <button id="fetchBtn" style="padding: 10px 20px; background: green; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Fetch Attendance Now
        </button> -->
    <!-- Academic Attendance -->
    <div class="card" id="academicCard">
      <div class="card-header">
        <h3>
          <span>üìö</span>
          Academic Attendance
        </h3>
      </div>
      <div class="card-body">
        <div id="academicTable" class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>Login to fetch attendance data</p>
        </div>
      </div>
    </div>

    <!-- Biometric Attendance -->
    <div class="card" id="biometricCard">
      <div class="card-header">
        <h3>
          <span>üîê</span>
          Biometric Attendance
        </h3>
      </div>
      <div class="card-body">
        <div id="biometricTable" class="empty-state">
          <div class="empty-state-icon">üë§</div>
          <p>Login to fetch attendance data</p>
        </div>
      </div>
    </div>

    <!-- Attendance Simulation -->
    <div class="card" id="todayClassesCard">
      <div class="card-header">
        <h3>
          <span>üéØ</span>
          Attendance Simulator
        </h3>
        <div class="simulation-controls">
          <button id="resetTodayBtn" title="Reset selections">‚Üª</button>
        </div>
      </div>
      <div class="card-body">
        <div id="todayClassesContainer"></div>
        <div id="newOverallAttendance"></div>
      </div>
    </div>
  </div>
</div>
<script>
    document.getElementById("fetchBtn").addEventListener("click", async function () {
    const status = document.getElementById("statusMsg");
    status.innerText = "Fetching attendance... please wait ‚è≥";

    try {
      const res = await fetch("https://attendance-4rm8.onrender.com/run-cron");
      const data = await res.json();

      if (data.success) {
        status.innerText = "‚úÖ Attendance fetched successfully!";
      } else {
        status.innerText = "‚ö†Ô∏è Error: " + data.message;
      }
    } catch (err) {
      status.innerText = "‚ùå Request failed. Check console/logs.";
      console.error(err);
    }
  });
</script>


<script>
const passwordField = document.getElementById('passwordField');
const togglePassword = document.getElementById('togglePassword');
const eyeOpen = document.getElementById('eyeOpen');
const eyeClosed = document.getElementById('eyeClosed');
const formLoader = document.getElementById('formLoader');
const logoutBtn = document.getElementById('logoutBtn');
const loginCard = document.getElementById('loginCard');
const dashboardCards = document.getElementById('dashboardCards');
const visitsBadge = document.getElementById('visitsBadge');
const visitsCount = document.getElementById('visitsCount');
const resetBtn = document.getElementById('resetTodayBtn');
const todayContainer = document.getElementById('todayClassesContainer');
const newOverallEl = document.getElementById('newOverallAttendance');
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');

// Theme Management - Initialize on page load
function initTheme() {
  const currentTheme = localStorage.getItem('theme') || 
    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

  if (currentTheme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
    themeIcon.textContent = '‚òÄÔ∏è';
  } else {
    document.body.removeAttribute('data-theme');
    themeIcon.textContent = 'üåô';
  }
}

// Initialize theme immediately
initTheme();

themeToggle.addEventListener('click', () => {
  const theme = document.body.getAttribute('data-theme');
  if (theme === 'dark') {
    document.body.removeAttribute('data-theme');
    themeIcon.textContent = 'üåô';
    localStorage.setItem('theme', 'light');
  } else {
    document.body.setAttribute('data-theme', 'dark');
    themeIcon.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme', 'dark');
  }
});

togglePassword.addEventListener('click', () => {
  const type = passwordField.type === 'password' ? 'text' : 'password';
  passwordField.type = type;
  eyeOpen.style.display = type === 'password' ? 'block' : 'none';
  eyeClosed.style.display = type === 'password' ? 'none' : 'block';
});

function showDashboard(studentId) {
  loginCard.style.display = 'none';
  dashboardCards.style.display = 'block';
  setTimeout(() => {
    dashboardCards.classList.add('show');
  }, 10);
  document.querySelector('header h2').textContent = `${studentId}'s Dashboard`;
  logoutBtn.style.display = 'block';
  logoutBtn.onclick = () => { location.reload(); };
  visitsBadge.style.display = 'flex';
  document.getElementById('todayClassesCard').style.display = 'block';
  resetBtn.style.display = 'block';
}

async function updateTodayVisits() {
  try {
    const res = await fetch('https://attendance-4rm8.onrender.com/today-logins');
    if (!res.ok) throw new Error('Failed to fetch today visits');
    const data = await res.json();
    visitsCount.textContent = data.today_logins || 0;
  } catch (err) {
    console.error('Error fetching today visits:', err);
    visitsCount.textContent = '?';
  }
}
// Caching System (10-minute expiration)
// Caching System (10-minute expiration, cleared on tab close)
const CACHE_DURATION = 5 * 60 * 1000; // 10 minutes

function setCache(key, data) {
  const record = { data, timestamp: Date.now() };
  sessionStorage.setItem(key, JSON.stringify(record));
}

function getCache(key) {
  const item = sessionStorage.getItem(key);
  if (!item) return null;

  try {
    const record = JSON.parse(item);
    if (Date.now() - record.timestamp < CACHE_DURATION) {
      return record.data;
    } else {
      sessionStorage.removeItem(key);
      return null;
    }
  } catch (e) {
    console.error("Cache parse error", e);
    return null;
  }
}


document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const username = formData.get('username');
  const password = formData.get('password');

  formLoader.style.display = 'block';
  const academicEl = document.getElementById('academicTable');
  const biometricEl = document.getElementById('biometricTable');

  const cacheKey = `attendance_${username}`;
  const cachedData = getCache(cacheKey);
  
  if (cachedData) {
    console.log("Loaded from cache:", cacheKey);
    showDashboard(username);
    renderAcademic(cachedData.academic);
    renderBiometric(cachedData.biometric);
    formLoader.style.display = "none";
    updateTodayVisits();
    return;
  }


  try {
    const res = await fetch('https://attendance-4rm8.onrender.com/get-attendance', {
      method: 'POST',
      body: new URLSearchParams({ username, password })
    });

    if (!res.ok) throw new Error('Network response was not ok');

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let academicData = [];
    let biometricData = {};

    showDashboard(username);
    academicEl.innerHTML = '<div class="loading-state"><div class="loader"></div><p>Loading Academic Attendance...</p></div>';
    biometricEl.innerHTML = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        if (!line.trim()) continue;
        try {
          const obj = JSON.parse(line);
                     console.log("STREAM RECEIVED ‚Üí", obj); 

          if (obj.step === 'academic') { academicData = obj.data; renderAcademic(obj.data); }
          if (obj.step === 'biometric') { biometricData = obj.data; renderBiometric(obj.data); }
        } catch (err) { console.error('Invalid JSON:', line); }
      }
    }

    // Save in cache for 10 minutes
    setCache(cacheKey, { academic: academicData, biometric: biometricData });
    updateTodayVisits();

  } catch (err) {
    console.error(err);
    alert('Network error or wrong credentials.');
    academicEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load data</p></div>';
  } finally {
    formLoader.style.display = 'none';
  }
});

function renderAcademic(data) {
  if (!Array.isArray(data) || data.length === 0) {
    document.getElementById('academicTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No academic data available</p></div>';
    return;
  }

  let total = 0;
  data.forEach(sub => total += Number(sub.percentage) || 0);
  const avg = (total / data.length).toFixed(2);

  // Update stats cards
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-card-header">
        <div>
          <div class="stat-card-title">Average Attendance</div>
          <div class="stat-card-value">${avg}%</div>
          <div class="stat-card-label">Academic Performance</div>
        </div>
        <div class="stat-card-icon" style="background: var(--primary-light); color: var(--primary);">üìä</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-header">
        <div>
          <div class="stat-card-title">Total Subjects</div>
          <div class="stat-card-value">${data.length}</div>
          <div class="stat-card-label">Enrolled Courses</div>
        </div>
        <div class="stat-card-icon" style="background: var(--success-light); color: var(--success);">üìö</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-header">
        <div>
          <div class="stat-card-title">Status</div>
          <div class="stat-card-value">${avg >= 75 ? '‚úì' : '‚ö†'}</div>
          <div class="stat-card-label">${avg >= 75 ? 'On Track' : 'Needs Attention'}</div>
        </div>
        <div class="stat-card-icon" style="background: ${avg >= 75 ? 'var(--success-light)' : 'var(--danger-light)'}; color: ${avg >= 75 ? 'var(--success)' : 'var(--danger)'};">${avg >= 75 ? '‚úì' : '!'}</div>
      </div>
    </div>
  `;

  let html = '<div class="table-scroll-hint">‚¨ÖÔ∏è Scroll to see more ‚¨ÖÔ∏è</div><div class="table-wrapper"><table><thead><tr>';
  html += '<th>Course Code</th><th>Subject</th><th>Attended</th><th>Tot</th><th>Percentage</th><th>To 75%</th><th>Can Bunk</th><th>Progress</th>';
  html += '</tr></thead><tbody>';

  data.forEach(sub => {
    const pct = Number(sub.percentage) || 0;
    const bg = pct >= 75 ? 'var(--gradient-success)' : 'var(--gradient-danger)';
    html += `<tr>
      <td><strong>${escapeHtml(sub.courseCode)}</strong></td>
      <td>${escapeHtml(sub.subject)}</td>
      <td>${escapeHtml(sub.attended)}</td>
      <td>${escapeHtml(sub.total)}</td>
      <td><span class="badge ${pct >= 75 ? 'badge-success' : 'badge-danger'}">${pct.toFixed(2)}%</span></td>
      <td>${escapeHtml(sub.classesToAttendFor75)}</td>
      <td>${escapeHtml(sub.classesCanBunk)}</td>
      <td><div class="progress"><div class="progress-bar" style="width:${pct}%;background:${bg}">${pct.toFixed(0)}%</div></div></td>
    </tr>`;
  });

  html += '</tbody></table></div>';
  document.getElementById('academicTable').innerHTML = html;

  createTodayRows();
  setTimeout(() => {
    const tableWrapper = document.querySelector('.table-wrapper');
    const table = tableWrapper?.querySelector('table');
    function updateTable3D() {
      if (!tableWrapper || !table) return;
      const maxScroll = tableWrapper.scrollWidth - tableWrapper.clientWidth;
      const scrollX = tableWrapper.scrollLeft;
      // The 3D "angle" based on scroll position
      const percent = maxScroll ? scrollX / maxScroll : 0;
      const angle = (percent - 0.5) * 12; // -6deg to +6deg 
      table.style.transform = `rotateY(${angle}deg)`;
    }
    if (tableWrapper && table) {
      tableWrapper.addEventListener('scroll', updateTable3D);
      updateTable3D();
    }
  }, 100);


}

function renderBiometric(data) {
  if (!data) {
    document.getElementById('biometricTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No biometric data available</p></div>';
    return;
  }

  const pct = Number(data.percentage) || 0;
  const totalDays = Number(data.totalDays) || 0;
  const presentCount = Number(data.presentCount) || 0;

  const target = 0.75;
  const daysToAttend = Math.max(0, Math.ceil(((target * totalDays) - presentCount) / (1 - target)));
  const leavesCanTake = Math.max(0, Math.floor((presentCount - (target * totalDays)) / target));

  const bg = pct >= 75 ? 'var(--gradient-success)' : 'var(--gradient-danger)';

  document.getElementById('biometricTable').innerHTML = `
    <div style="display: grid; gap: 16px;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
        <div style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: ${pct >= 75 ? 'var(--success)' : 'var(--danger)'};">${pct.toFixed(2)}%</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Attendance %</div>
        </div>
        <div style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${totalDays}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Total Days</div>
        </div>
        <div style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--success);">${presentCount}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Present Days</div>
        </div>
        <div style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${daysToAttend}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">To Reach 75%</div>
        </div>
        <div style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${leavesCanTake}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Can Bunk</div>
        </div>
      </div>
      <div>
        <div class="progress">
          <div class="progress-bar" style="width:${pct}%;background:${bg}">${pct.toFixed(0)}%</div>
        </div>
      </div>
    </div>
  `;
}


function createTodayRows() {
  todayContainer.innerHTML = '';

  const subjectEls = document.querySelectorAll('#academicTable table tbody tr td:nth-child(2)');
  const subjects = Array.from(subjectEls).map(el => el.textContent.trim()).filter(Boolean);
  if (subjects.length === 0) return;

  for (let i = 0; i < 6; i++) {
    const row = document.createElement('div');
    row.className = 'today-row';

    const select = document.createElement('select');
    subjects.forEach(s => {
      const o = document.createElement('option');
      o.value = s;
      o.text = s;
      select.add(o);
    });
    select.onchange = calculateNewOverall;

    const attendBtn = document.createElement('button');
    attendBtn.textContent = 'Attend';
    attendBtn.dataset.status = '';
    attendBtn.className = 'btn attend-btn';
    attendBtn.onclick = () => {
      attendBtn.dataset.status = 'attend';
      bunkBtn.dataset.status = '';
      attendBtn.classList.add('active');
      bunkBtn.classList.remove('active');
      calculateNewOverall();
    };

    const bunkBtn = document.createElement('button');
    bunkBtn.textContent = 'Bunk';
    bunkBtn.dataset.status = '';
    bunkBtn.className = 'btn bunk-btn';
    bunkBtn.onclick = () => {
      bunkBtn.dataset.status = 'bunk';
      attendBtn.dataset.status = '';
      bunkBtn.classList.add('active');
      attendBtn.classList.remove('active');
      calculateNewOverall();
    };

    const btnContainer = document.createElement('div');
    btnContainer.className = 'btn-container';
    btnContainer.appendChild(attendBtn);
    btnContainer.appendChild(bunkBtn);

    row.appendChild(select);
    row.appendChild(btnContainer);
    todayContainer.appendChild(row);
  }

  newOverallEl.textContent = 'Select attend or bunk for each class to see predicted attendance';
}

resetBtn.addEventListener('click', () => {
  const rows = todayContainer.querySelectorAll('.today-row');
  rows.forEach(row => {
    const attendBtn = row.querySelector('.attend-btn');
    const bunkBtn = row.querySelector('.bunk-btn');
    const select = row.querySelector('select');

    attendBtn.dataset.status = '';
    bunkBtn.dataset.status = '';
    attendBtn.classList.remove('active');
    bunkBtn.classList.remove('active');

    if (select.options.length > 0) select.selectedIndex = 0;
  });

  newOverallEl.textContent = 'Select attend or bunk for each class to see predicted attendance';
});

function calculateNewOverall() {
  const rows = todayContainer.querySelectorAll('.today-row');
  if (rows.length === 0) return;

  const subjectMap = {};
  const trEls = document.querySelectorAll('#academicTable table tbody tr');
  trEls.forEach(tr => {
    const tds = tr.querySelectorAll('td');
    const sub = tds[1].textContent.trim();
    subjectMap[sub] = {
      attended: Number(tds[2].textContent),
      total: Number(tds[3].textContent)
    };
  });

  rows.forEach(row => {
    const attendBtn = row.querySelector('.attend-btn');
    const bunkBtn = row.querySelector('.bunk-btn');
    const select = row.querySelector('select');
    const sub = select.value;
    if (!subjectMap[sub]) return;

    if (attendBtn.dataset.status === 'attend') {
      subjectMap[sub].attended += 1;
      subjectMap[sub].total += 1;
    } else if (bunkBtn.dataset.status === 'bunk') {
      subjectMap[sub].total += 1;
    }
  });

  let sumPct = 0;
  let count = 0;
  for (const sub in subjectMap) {
    const s = subjectMap[sub];
    const pct = s.total ? (s.attended / s.total) * 100 : 0;
    sumPct += pct;
    count++;
  }
  const newAvg = (sumPct / count).toFixed(2);
  const color = newAvg >= 75 ? 'var(--success)' : 'var(--danger)';
  const bg = newAvg >= 75 ? 'var(--gradient-success)' : 'var(--gradient-danger)';
  newOverallEl.innerHTML = `
    Predicted Overall Attendance: ${newAvg}%<br>
    <div class="progress" style="margin-top:16px;">
      <div class="progress-bar" style="width:${newAvg}%;background:${bg};color: white;">
        ${newAvg}%
      </div>
    </div>
  `;
  newOverallEl.style.background = newAvg >= 75 ? 'var(--success-light)' : 'var(--danger-light)';
  newOverallEl.style.color = color;
  newOverallEl.style.borderColor = color;
}

function escapeHtml(v) {
  if (v === undefined || v === null) return '';
  return String(v)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
</script>
</body>
</html>
