<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance Dashboard</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  
<style>
:root {
  /* Modern Color Palette */
  --primary: #6366f1;
  --primary-hover: #4f46e5;
  --primary-light: #eef2ff;
  --secondary: #8b5cf6;
  --success: #10b981;
  --success-light: #d1fae5;
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --info: #06b6d4;
  
  /* Neutrals - Light Mode */
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Gradient */
  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --gradient-danger: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
  
  /* Spacing */
  --radius: 12px;
  --radius-lg: 16px;
  --radius-full: 9999px;
}

/* Dark Mode */
body[data-theme="dark"] {
  /* Dark Mode Colors */
  --primary-light: #312e81;
  --success-light: #064e3b;
  --danger-light: #7f1d1d;
  --warning-light: #78350f;
  
  /* Neutrals - Dark Mode */
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --border: #334155;
  --border-light: #293548;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

/* Header */
header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 16px 0;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-sm);
}

.header-container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  width: 40px;
  height: 40px;
  background: var(--gradient-primary);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 18px;
}

header h2 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}
#themeToggle { ... }
/* trimmed for brevity in canvas view - full styles kept unchanged */
</style>
</head>
<body>
<div style="position: fixed; bottom: 10px; right: 10px; z-index: 999; font-size: 12px; color: #999;">
    UMA CREATIONS
</div>


<header>
  <div class="header-container">
    <div class="header-title">
      <div class="logo">üìä</div>
      <h2>My Attendance Dashboard</h2>
    </div>
    <div class="header-actions">
      <button id="themeToggle" title="Toggle dark mode" style="display: flex !important;">
        <span id="themeIcon">üåô</span>
      </button>
      <div id="visitsBadge">
        <span>üë•</span>
        <span id="visitsCount">0</span>
      </div>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Login Card -->
  <div class="login-card" id="loginCard">
    <div class="login-header">
      <div class="login-icon">üéì</div>
      <h3>Student Login</h3>
      <p>Enter your credentials to view your attendance</p>
    </div>

    <form id="loginForm" autocomplete="on">
      <div class="field">
        <label for="username">Student ID</label>
        <input type="text" name="username" id="username" placeholder="Enter your student ID" required>
      </div>
      <div class="field password-field">
        <label for="passwordField">Password</label>
        <input type="password" name="password" id="passwordField" placeholder="Enter your password" required>
        <span id="togglePassword" class="toggle-icon">
          <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><path d="M3 3l18 18"/></svg>
        </span>
      </div>
      <button type="submit" class="btn" id="loginBtn">
        <span>Sign In</span>
      </button>
      <div id="formLoader">
        <div class="loader"></div>
        <p>Fetching your attendance data...<br>Please wait a moment</p>
      </div>
    </form>
    
  </div>
  <div id="skeletonLoader" class="skeleton-container" style="display:none;">
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card wide"></div>
  </div>

   <!-- Dashboard -->
  <div class="dashboard-grid" id="dashboardCards" style="display:none;">
    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid"></div>
      <!-- Academic Attendance -->
    <div class="card" id="academicCard" style="display:none;">
      <div class="card-header">
        <h3>
          <span>üìö</span>
          Academic Attendance
        </h3>
      </div>
      <div class="card-body">
        <div id="academicTable" class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>Login to fetch attendance data</p>
        </div>
      </div>
    </div>

    <!-- Biometric Attendance -->
    <div class="card" id="biometricCard" style="display:none;">
      <div class="card-header">
        <h3>
          <span>üîê</span>
          Biometric Attendance
        </h3>
      </div>
      <div class="card-body">
        <div id="biometricTable" class="empty-state">
          <div class="empty-state-icon">üë§</div>
          <p>Login to fetch attendance data</p>
        </div>
        <div id="biometricSection">
          <div class="btn-container">
            <button id="biometricAttendBtn" class="btn attend-btn">Attend</button>
            <button id="biometricBunkBtn" class="btn bunk-btn">Bunk</button>
          </div>
          <p id="attendanceMessage"></p>
        </div>
      </div>
    </div>
</div>
 
 <div class="stats-grid" id="periodStatsGrid" style="margin-top:40px; display:none;"></div>


    <!-- Attendance Simulation -->
    <div class="card" id="todayClassesCard" style="display:none;">
      <div class="card-header">
        <h3>
          <span>üéØ</span>
          Attendance Simulator
        </h3>
        <div class="simulation-controls">
          <button id="resetTodayBtn" title="Reset selections">‚Üª</button>
        </div>
      </div>
      <div class="card-body">
        <div id="todayClassesContainer"></div>
        <div id="newOverallAttendance"></div>
      </div>
    </div>
  </div>
</div>
<!-- Bottom Navigation -->
<div id="bottomNav" class="bottom-nav" style="display:none;">
  <button data-screen="dashboard" class="active">üè† Dashboard</button>
  <button data-screen="biometric">üîê Biometric</button>
  <button data-screen="latest">üìò Latest</button>
  <button data-screen="academic">üìö Academic</button>
</div>


<script>
// --- element refs ---
const passwordField = document.getElementById('passwordField');
const togglePassword = document.getElementById('togglePassword');
const eyeOpen = document.getElementById('eyeOpen');
const eyeClosed = document.getElementById('eyeClosed');
const formLoader = document.getElementById('formLoader');
const logoutBtn = document.getElementById('logoutBtn');
const loginCard = document.getElementById('loginCard');
const dashboardCards = document.getElementById('dashboardCards');
const visitsBadge = document.getElementById('visitsBadge');
const visitsCount = document.getElementById('visitsCount');
const resetBtn = document.getElementById('resetTodayBtn');
const todayContainer = document.getElementById('todayClassesContainer');
const newOverallEl = document.getElementById('newOverallAttendance');
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const bottomNav = document.getElementById('bottomNav');

// Keep simple theme init
function initTheme() {
  const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  if (currentTheme === 'dark') { document.body.setAttribute('data-theme','dark'); themeIcon.textContent='‚òÄÔ∏è'; }
  else { document.body.removeAttribute('data-theme'); themeIcon.textContent='üåô'; }
}
initTheme();

// Toggle
themeToggle.addEventListener('click', ()=>{
  const t = document.body.getAttribute('data-theme');
  if (t==='dark') { document.body.removeAttribute('data-theme'); themeIcon.textContent='üåô'; localStorage.setItem('theme','light'); }
  else { document.body.setAttribute('data-theme','dark'); themeIcon.textContent='‚òÄÔ∏è'; localStorage.setItem('theme','dark'); }
});

// Password toggle (safe guard if missing)
if (togglePassword && passwordField) {
  togglePassword.addEventListener('click', ()=>{
    const type = passwordField.type === 'password' ? 'text' : 'password';
    passwordField.type = type;
    if (eyeOpen) eyeOpen.style.display = type === 'password' ? 'block' : 'none';
    if (eyeClosed) eyeClosed.style.display = type === 'password' ? 'none' : 'block';
  });
}

// Visits fetch (best-effort)
async function updateTodayVisits(){
  try{
    const res = await fetch('https://attendance-4rm8.onrender.com/today-logins');
    if (!res.ok) throw new Error('nf');
    const d = await res.json(); visitsCount.textContent = d.today_logins||0;
  }catch(e){ visitsCount.textContent='?'; }
}
window.addEventListener('DOMContentLoaded', ()=>{ visitsBadge.style.display='flex'; updateTodayVisits(); });

// screens (groups)
const screens = {
  dashboard: [ document.getElementById('dashboardCards'), document.getElementById('academicCard') ],
  biometric: [ document.getElementById('biometricCard') ],
  latest: [ document.getElementById('periodStatsGrid') ],
  academic: [ document.getElementById('todayClassesCard') ]
};

function hideAllScreens(){
  Object.values(screens).forEach(arr=>arr.forEach(el=>{ if (el) el.style.display='none'; }));
}

function showScreen(name){
  hideAllScreens();
  const group = screens[name] || [];
  group.forEach(el=>{ if (el) el.style.display = 'block'; });
  // ensure dashboard container is visible when any dashboard pieces shown
  if (name === 'dashboard') document.getElementById('dashboardCards').style.display = 'grid';
  // highlight nav
  document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.screen===name));
}

// wire bottom nav
document.querySelectorAll('.bottom-nav button').forEach(btn => {
  btn.addEventListener('click', ()=>{
    const screen = btn.dataset.screen;
    showScreen(screen);
  });
});

// helper: show dashboard after login
function showDashboard(studentId){
  loginCard.style.display = 'none';
  dashboardCards.style.display = 'grid';
  document.querySelector('header h2').textContent = `${studentId}'s Dashboard`;
  logoutBtn.style.display = 'block';
  logoutBtn.onclick = ()=> location.reload();
  visitsBadge.style.display = 'flex';
  // show bottom nav and default dashboard group
  bottomNav.style.display = 'flex';
  // show both stats area and academic card
  showScreen('dashboard');
  // ensure simulator available
  document.getElementById('todayClassesCard').style.display = 'block';
  resetBtn.style.display = 'inline-block';
}

// login form
document.getElementById('loginForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const username = fd.get('username');
  const password = fd.get('password');

  // show skeleton while fetching
  loginCard.style.display='none';
  document.getElementById('skeletonLoader').style.display='grid';

  try{
    const res = await fetch('https://attendance-4rm8.onrender.com/get-attendance', {
      method:'POST', body: new URLSearchParams({ username, password })
    });
    if (!res.ok) throw new Error('auth');
    const text = await res.text();
    const lines = text.split('\n');
    let academicData, biometricData, latestAttendance;
    lines.forEach(l=>{ if (!l.trim()) return; const o = JSON.parse(l); if (o.step==='academic') academicData = o.data; if (o.step==='biometric') biometricData = o.data; if (o.step==='latest') latestAttendance = o.data; });

    if (!academicData || academicData.length===0) throw new Error('noacadem');

    document.getElementById('skeletonLoader').style.display='none';
    showDashboard(username);
    renderAcademic(academicData, username);
    renderBiometric(biometricData);
    if (latestAttendance) renderLatestAttendance(latestAttendance);
  }catch(err){
    document.getElementById('skeletonLoader').style.display='none';
    loginCard.style.display='block';
    bottomNav.style.display='none';
    alert('Login failed ‚Äî check creds or network');
  }
});

// renderAcademic, renderBiometric, renderLatestAttendance, createTodayRows, calculateNewOverall
// (functions copied exactly from your file to preserve logic)

function renderAcademic(data, username){
  if (!Array.isArray(data) || data.length===0){ document.getElementById('academicTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No academic data available</p></div>'; return; }

  let total = 0; data.forEach(sub=> total += Number(sub.percentage)||0);
  const avg = (total / data.length).toFixed(2);
  let T=0, tot=0; data.forEach(sub=> T+=Number(sub.attended)||0); data.forEach(sub=> tot+=Number(sub.total)||0);
  const TT = tot?((T*100/tot).toFixed(2)):'0.00';

  const statsGrid = document.getElementById('statsGrid');
  let statsHtml = `
    <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Average Attendance</div><div class="stat-card-value">${avg}%</div><div class="stat-card-label">Academic Performance</div></div><div class="stat-card-icon" style="background: var(--primary-light); color: var(--primary);">üìä</div></div></div>
  `;
  statsHtml += `
    <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Total Attend/Total</div><div class="stat-card-value">${TT}%</div><div class="stat-card-label">Performance</div></div><div class="stat-card-icon" style="background: var(--success-light); color: var(--success);">üìö</div></div></div>
  `;
  statsGrid.innerHTML = statsHtml;

  let html = '<div class="table-scroll-hint">‚¨ÖÔ∏è Scroll to see more ‚¨ÖÔ∏è</div><div class="table-wrapper"><table><thead><tr>';
  html += '<th>Course Code</th><th>Subject</th><th>Attended</th><th>Tot</th><th>Percentage</th><th>To 75%</th><th>Can Bunk</th><th>Progress</th>';
  html += '</tr></thead><tbody>';

  data.forEach(sub=>{
    const pct = Number(sub.percentage)||0;
    const bg = pct>=75? 'var(--gradient-success)' : 'var(--gradient-danger)';
    html += `<tr><td><strong>${escapeHtml(sub.courseCode)}</strong></td><td>${escapeHtml(sub.subject)}</td><td>${escapeHtml(sub.attended)}</td><td>${escapeHtml(sub.total)}</td><td><span class="badge ${pct>=75? 'badge-success':'badge-danger'}">${pct.toFixed(2)}%</span></td><td>${escapeHtml(sub.classesToAttendFor75)}</td><td>${escapeHtml(sub.classesCanBunk)}</td><td><div class="progress"><div class="progress-bar" style="width:${pct}%;background:${bg}">${pct.toFixed(0)}%</div></div></td></tr>`;
  });

  html += '</tbody></table></div>';
  document.getElementById('academicTable').innerHTML = html;
  // ensure academic card visible in dashboard
  document.getElementById('academicCard').style.display = 'block';
  createTodayRows();
}

function renderBiometric(data){
  if (!data){ document.getElementById('biometricTable').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No biometric data available</p></div>'; return; }
  const pct = Number(data.percentage)||0;
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML += `
    <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Biometric %</div><div class="stat-card-value">${pct.toFixed(2)}%</div><div class="stat-card-label">Biometric Attendance</div></div><div class="stat-card-icon" style="background: var(--primary-light); display:flex;align-items:center;justify-content:center;">üîê</div></div></div>
  `;

  // populate biometric panel
  const totalDays = Number(data.totalDays)||0; const presentCount = Number(data.presentCount)||0;
  const bg = pct>=75? 'var(--gradient-success)' : 'var(--gradient-danger)';
  document.getElementById('biometricTable').innerHTML = `
    <div style="display:grid;gap:16px;"><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;"><div style="background:var(--bg-primary);padding:16px;border-radius:var(--radius);text-align:center;"><div style="font-size:24px;font-weight:700;color:${pct>=75? 'var(--success)':'var(--danger)'}">${pct.toFixed(2)}%</div><div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">Attendance %</div></div><div style="background:var(--bg-primary);padding:16px;border-radius:var(--radius);text-align:center;"><div style="font-size:24px;font-weight:700;color:var(--text-primary);">${totalDays}</div><div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">Total Days</div></div><div style="background:var(--bg-primary);padding:16px;border-radius:var(--radius);text-align:center;"><div style="font-size:24px;font-weight:700;color:var(--success);">${presentCount}</div><div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">Present Days</div></div></div><div><div class="progress"><div class="progress-bar" style="width:${pct}%;background:${bg}">${pct.toFixed(0)}%</div></div></div></div>`;
  document.getElementById('biometricCard').style.display='block';
}

function renderLatestAttendance(rows){
  const container = document.getElementById('periodStatsGrid'); container.innerHTML='';
  const periods = {1:{status:'NOT UPDATED',subject:'-',date:'-'},2:{status:'NOT UPDATED',subject:'-',date:'-'},3:{status:'NOT UPDATED',subject:'-',date:'-'},4:{status:'NOT UPDATED',subject:'-',date:'-'},5:{status:'NOT UPDATED',subject:'-',date:'-'},6:{status:'NOT UPDATED',subject:'-',date:'-'}};
  const today = new Date(); const day = today.toLocaleString('en-GB',{timeZone:'Asia/Kolkata',day:'2-digit'}); const month = today.toLocaleString('en-GB',{timeZone:'Asia/Kolkata',month:'short'}); const year = today.toLocaleString('en-GB',{timeZone:'Asia/Kolkata',year:'numeric'});
  const todayStr = `${day} ${month}, ${year}`;
  const normalize = s => s.replace(/[\u00A0\u2007\u202F]/g,' ').replace(/,/g,'').replace(/\s+/g,' ').trim().toLowerCase();
  const todayNorm = normalize(todayStr);
  const subjectMap = {};
  rows.forEach(r=>{ if (!subjectMap[r.subject]) subjectMap[r.subject]=[]; subjectMap[r.subject].push(r); });
  Object.values(subjectMap).forEach(arr=> arr.forEach(r=>{ if (normalize(r.date)!==todayNorm) return; const p = Number(r.period); if (p>=1&&p<=6) periods[p]={ status: r.status?.toUpperCase()||'NOT UPDATED', subject: r.subject, date: r.date }; }));
  for (let p=1;p<=6;p++){ const info = periods[p]; let color='var(--warning)'; let bg='var(--warning-light)'; if (info.status==='PRESENT'){ color='var(--success)'; bg='var(--success-light)'; } else if (info.status==='ABSENT'){ color='var(--danger)'; bg='var(--danger-light)'; } container.innerHTML += `<div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">PERIOD ${p}</div><div class="stat-card-value" style="color:${color};">${info.status}</div><div class="stat-card-label"><strong>${info.subject}</strong><br><small>${info.date}</small></div></div><div class="stat-card-icon" style="background:${bg}; color:${color};">üìò</div></div></div>`; }
  container.style.display='grid';
}

function createTodayRows(){
  todayContainer.innerHTML='';
  const subjectEls = document.querySelectorAll('#academicTable table tbody tr td:nth-child(2)');
  const subjects = Array.from(subjectEls).map(el=>el.textContent.trim()).filter(Boolean);
  if (subjects.length===0) return;
  for (let i=0;i<6;i++){
    const row = document.createElement('div'); row.className='today-row';
    const select = document.createElement('select'); subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.text=s; select.add(o); }); select.onchange = calculateNewOverall;
    const attendBtn = document.createElement('button'); attendBtn.textContent='Attend'; attendBtn.dataset.status=''; attendBtn.className='btn attend-btn';
    const bunkBtn = document.createElement('button'); bunkBtn.textContent='Bunk'; bunkBtn.dataset.status=''; bunkBtn.className='btn bunk-btn';
    attendBtn.onclick = ()=>{ attendBtn.dataset.status='attend'; bunkBtn.dataset.status=''; attendBtn.classList.add('active'); bunkBtn.classList.remove('active'); calculateNewOverall(); };
    bunkBtn.onclick = ()=>{ bunkBtn.dataset.status='bunk'; attendBtn.dataset.status=''; bunkBtn.classList.add('active'); attendBtn.classList.remove('active'); calculateNewOverall(); };
    const btnContainer = document.createElement('div'); btnContainer.className='btn-container'; btnContainer.appendChild(attendBtn); btnContainer.appendChild(bunkBtn);
    row.appendChild(select); row.appendChild(btnContainer); todayContainer.appendChild(row);
  }
  newOverallEl.textContent = 'Select attend or bunk for each class to see predicted attendance';
}

resetBtn.addEventListener('click', ()=>{ const rows = todayContainer.querySelectorAll('.today-row'); rows.forEach(row=>{ const a=row.querySelector('.attend-btn'); const b=row.querySelector('.bunk-btn'); const s=row.querySelector('select'); if(a) { a.dataset.status=''; a.classList.remove('active'); } if(b) { b.dataset.status=''; b.classList.remove('active'); } if(s && s.options.length) s.selectedIndex = 0; }); newOverallEl.textContent = 'Select attend or bunk for each class to see predicted attendance'; });

function calculateNewOverall(){
  const rows = todayContainer.querySelectorAll('.today-row'); if (rows.length===0) return;
  const subjectMap = {}; const trEls = document.querySelectorAll('#academicTable table tbody tr'); trEls.forEach(tr=>{ const tds=tr.querySelectorAll('td'); const sub = tds[1].textContent.trim(); subjectMap[sub] = { attended: Number(tds[2].textContent), total: Number(tds[3].textContent) }; });
  rows.forEach(row=>{ const attendBtn=row.querySelector('.attend-btn'); const bunkBtn=row.querySelector('.bunk-btn'); const select=row.querySelector('select'); const sub=select.value; if(!subjectMap[sub]) return; if (attendBtn.dataset.status==='attend'){ subjectMap[sub].attended+=1; subjectMap[sub].total+=1; } else if (bunkBtn.dataset.status==='bunk'){ subjectMap[sub].total+=1; } });
  let sumPct=0, count=0; for (const sub in subjectMap){ const s=subjectMap[sub]; const pct = s.total ? (s.attended/s.total)*100 : 0; sumPct += pct; count++; }
  const subjectAvg = (sumPct/count).toFixed(2);
  let totalPresent=0, totalClasses=0; for (const sub in subjectMap){ const s=subjectMap[sub]; totalPresent += s.attended; totalClasses += s.total; }
  const overallAvg = totalClasses? ((totalPresent/totalClasses)*100).toFixed(2) : '0.00';
  const subBg = subjectAvg>=75? 'var(--gradient-success)': 'var(--gradient-danger)'; const overBg = overallAvg>=75? 'var(--gradient-success)': 'var(--gradient-danger)';
  newOverallEl.innerHTML = `<div style="margin-bottom:12px;"><b>Subject-wise Average:</b> ${subjectAvg}%<br><div class="progress" style="margin-top:6px;"><div class="progress-bar" style="width:${subjectAvg}%; background:${subBg}; color:white;">${subjectAvg}%</div></div></div><div><b>Total Present / Total Classes:</b> ${overallAvg}%<br><div class="progress" style="margin-top:6px;"><div class="progress-bar" style="width:${overallAvg}%; background:${overBg}; color:white;">${overallAvg}%</div></div></div>`;
  newOverallEl.style.background = overallAvg>=75? 'var(--success-light)': 'var(--danger-light)';
}

function escapeHtml(v){ if (v===undefined||v===null) return ''; return String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

// set initial UI: show login only
hideAllScreens(); document.getElementById('skeletonLoader').style.display='none'; bottomNav.style.display='none';

</script>
</body>
</html>
