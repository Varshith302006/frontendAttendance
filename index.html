<form id="loginForm">
    <input type="text" name="username" placeholder="Student ID" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit" class="btn">Get Attendance</button>
</form>

<div class="cards">
    <div class="card" id="academicCard">
        <h3>Academic Attendance</h3>
        <div id="academicTable">Login to fetch attendance</div>
    </div>

    <div class="card" id="biometricCard">
        <h3>Biometric Attendance</h3>
        <div id="biometricTable">Login to fetch attendance</div>
    </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const username = formData.get('username');
    const password = formData.get('password');

    document.getElementById('academicTable').innerHTML = 'Loading Academic...';
    document.getElementById('biometricTable').innerHTML = '';

    // 1️⃣ Fetch Academic first
    const res1 = await fetch('https://attendance-4rm8.onrender.com/get-academic', {
        method: 'POST',
        body: new URLSearchParams({ username, password })
    });
    const result1 = await res1.json();
    if (!result1.success) {
        document.getElementById('academicTable').innerHTML = 'Error: ' + result1.error;
        return;
    }
    renderAcademic(result1.data);

    // 2️⃣ Fetch Biometric next
    document.getElementById('biometricTable').innerHTML = 'Loading Biometric...';
    const res2 = await fetch('https://attendance-4rm8.onrender.com/get-biometric', {
        method: 'POST',
        body: new URLSearchParams({ username, password })
    });
    const result2 = await res2.json();
    if (!result2.success) {
        document.getElementById('biometricTable').innerHTML = 'Error: ' + result2.error;
        return;
    }
    renderBiometric(result2.data);
});

function renderAcademic(academicWithTargets) {
    let totalPercentage = 0;
    academicWithTargets.forEach(sub => totalPercentage += sub.percentage);
    const averagePercentage = (totalPercentage / academicWithTargets.length).toFixed(2);

    let html = `<p><strong>Average Academic Attendance: ${averagePercentage}%</strong></p>`;
    html += `<table>
        <tr>
            <th>Course Code</th>
            <th>Subject</th>
            <th>Attended</th>
            <th>Total</th>
            <th>Percentage</th>
            <th>To Reach 75%</th>
            <th>Can Bunk</th>
            <th>Progress</th>
        </tr>`;
    academicWithTargets.forEach(sub => {
        html += `<tr>
            <td>${sub.courseCode}</td>
            <td>${sub.subject}</td>
            <td>${sub.attended}</td>
            <td>${sub.total}</td>
            <td>${sub.percentage.toFixed(2)}%</td>
            <td>${sub.classesToAttendFor75}</td>
            <td>${sub.classesCanBunk}</td>
            <td>
                <div class="progress">
                    <div class="progress-bar" style="width:${sub.percentage}%;background:${sub.percentage>=75?'green':'red'}">
                        ${sub.percentage.toFixed(2)}%
                    </div>
                </div>
            </td>
        </tr>`;
    });
    html += '</table>';
    document.getElementById('academicTable').innerHTML = html;
}

function renderBiometric(biometricAttendance) {
    document.getElementById('biometricTable').innerHTML = `
        <p><strong>Total Days:</strong> ${biometricAttendance.totalDays}</p>
        <p><strong>Present Days:</strong> ${biometricAttendance.presentCount}</p>
        <p><strong>Attendance Percentage: ${biometricAttendance.percentage}%</strong></p>
        <div class="progress">
            <div class="progress-bar" style="width:${biometricAttendance.percentage}%;background:${biometricAttendance.percentage>=75?'green':'red'}">
                ${biometricAttendance.percentage}%
            </div>
        </div>
    `;
}
</script>
