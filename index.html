<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f6f9; color: #333; }
        header { background: #4CAF50; color: white; padding: 20px 40px; text-align: center; }
        h2 { margin: 0; }
        .container { width: 90%; max-width: 1200px; margin: 20px auto; }
        form { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        input[type="text"], input[type="password"] { padding: 10px; width: 200px; border: 1px solid #ccc; border-radius: 5px; }
        .btn { padding: 10px 20px; background: #4CAF50; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .cards { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .card { background: white; flex: 1 1 300px; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #4CAF50; color: white; }
        .progress { background: #ddd; width: 100%; height: 18px; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; text-align: center; color: white; line-height: 18px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h2>My Attendance Dashboard</h2>
</header>

<div class="container">
    <form id="loginForm">
        <input type="text" name="username" placeholder="Student ID" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit" class="btn">Get Attendance</button>
    </form>

    <div class="cards">
        <div class="card" id="academicCard">
            <h3>Academic Attendance</h3>
            <div id="academicTable">Login to fetch attendance</div>
        </div>

        <div class="card" id="biometricCard">
            <h3>Biometric Attendance</h3>
            <div id="biometricTable">Login to fetch attendance</div>
        </div>
    </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const username = formData.get('username');
    const password = formData.get('password');

    document.getElementById('academicTable').innerHTML = 'Loading academic attendance...';
    document.getElementById('biometricTable').innerHTML = 'Waiting for biometric attendance...';

    // --- Fetch Academic Attendance first ---
    let academicData = null;
    try {
        const res = await fetch('https://attendance-4rm8.onrender.com/get-academic', {
            method: 'POST',
            body: new URLSearchParams({ username, password })
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        academicData = result.data;
        const { academicWithTargets } = academicData;

        let totalPercentage = 0;
        academicWithTargets.forEach(sub => totalPercentage += sub.percentage);
        const averagePercentage = (totalPercentage / academicWithTargets.length).toFixed(2);

        let html = `<p><strong>Average Academic Attendance: ${averagePercentage}%</strong></p>`;
        html += `<table>
            <tr>
                <th>Course Code</th>
                <th>Subject</th>
                <th>Attended</th>
                <th>Total</th>
                <th>Percentage</th>
                <th>To Reach 75%</th>
                <th>Can Bunk</th>
                <th>Progress</th>
            </tr>`;
        academicWithTargets.forEach(sub => {
            html += `<tr>
                <td>${sub.courseCode}</td>
                <td>${sub.subject}</td>
                <td>${sub.attended}</td>
                <td>${sub.total}</td>
                <td>${sub.percentage.toFixed(2)}%</td>
                <td>${sub.classesToAttendFor75}</td>
                <td>${sub.classesCanBunk}</td>
                <td>
                    <div class="progress">
                        <div class="progress-bar" style="width:${sub.percentage}%;background:${sub.percentage>=75?'green':'red'}">
                            ${sub.percentage.toFixed(2)}%
                        </div>
                    </div>
                </td>
            </tr>`;
        });
        html += '</table>';
        document.getElementById('academicTable').innerHTML = html;

    } catch (err) {
        document.getElementById('academicTable').innerHTML = 'Error: ' + err.message;
        document.getElementById('biometricTable').innerHTML = '';
        return;
    }

    // --- Fetch Biometric Attendance after academic finishes ---
    try {
        const resBio = await fetch('https://attendance-4rm8.onrender.com/get-biometric', {
            method: 'POST',
            body: new URLSearchParams({ username, password })
        });
        const resultBio = await resBio.json();
        if (!resultBio.success) throw new Error(resultBio.error);

        const biometricAttendance = resultBio.data.biometricAttendance;

        document.getElementById('biometricTable').innerHTML = `
            <p><strong>Total Days:</strong> ${biometricAttendance.totalDays}</p>
            <p><strong>Present Days:</strong> ${biometricAttendance.presentCount}</p>
            <p><strong>Attendance Percentage: ${biometricAttendance.percentage}%</strong></p>
            <div class="progress">
                <div class="progress-bar" style="width:${biometricAttendance.percentage}%;background:${biometricAttendance.percentage>=75?'green':'red'}">
                    ${biometricAttendance.percentage}%
                </div>
            </div>
        `;
    } catch (err) {
        document.getElementById('biometricTable').innerHTML = 'Error: ' + err.message;
    }
});
</script>

</body>
</html>
